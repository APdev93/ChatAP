const chatContainer=document.getElementById("chat-container"),socket=io();let messages=[];const chatId=document.getElementById("chat_id").value,getLastChat=async()=>{try{let e=await fetch("/get_last_message",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chat_id:chatId})});e.ok||console.log("Error: ",e),(await e.json()).data.forEach((e=>{messages.push(e)})),console.log("messages successfully get"),console.log(messages)}catch(e){console.log(e)}};window.onload=()=>{getLastChat(),console.log(messages)};const MAX_FILE_SIZE=51200,fileInput=document.getElementById("imageInput");fileInput.addEventListener("change",(function(){const e=fileInput.files[0];e&&e.size>51200&&(fileInput.value="",document.getElementById("top").style.display="none",alert("File terlalu besar! Maksimal ukuran file adalah 50KB."))}));const getChatInfo=async()=>{let e=await fetch("/get_chat_info",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chat_id:chatId})});e.ok||console.log("Error: ",e);let t=e.json();console.log(t)},addHistoryMsg=async e=>{"user"===e.role&&messages.push(e);try{let t=await fetch("/add_history",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chat_id:chatId,data:e})});t.ok||console.log("Error: ",t);let n=t.json();return console.log(n),"user"!==e.role&&(messages.push(e),console.log(messages)),!0}catch(e){return console.log(e),!1}};document.getElementById("message-form").addEventListener("submit",(async function(e){e.preventDefault(),getChatInfo();const t=document.getElementById("message");t.style.height="45px",chatContainer.innerHTML="";const n=t.value,a=document.getElementById("imageInput").files[0];(new Date).toLocaleTimeString();let s,o=document.getElementById("btnSend");if(a){const e=new FileReader;e.onloadend=async function(){const a=e.result.replace("data:","").replace(/^.+,/,"");s={role:"user",content:{image:a,text:n}},addHistoryMsg(s),renderMessages(messages),t.value="",document.getElementById("imageInput").value="",document.getElementById("top").style.display="none",o.innerHTML='<span class="loading"></span>',o.setAttribute("disabled","true"),await sendMessage(n,s)},e.readAsDataURL(a)}else s={role:"user",content:n},addHistoryMsg(s),renderMessages(messages),t.value="",document.getElementById("imageInput").value="",o.innerHTML='<span class="loading"></span>',o.setAttribute("disabled","true"),await sendMessage(n,s)}));const applyPreferredTheme=()=>{window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.setAttribute("data-theme","dark"):document.documentElement.removeAttribute("data-theme")};applyPreferredTheme();const textarea=document.getElementById("message");var originalHeight=textarea.style.height;textarea.addEventListener("input",(function(){this.value.includes("\n")?this.style.borderRadius="25px":this.style.borderRadius="50px",""===this.value?this.style.height=originalHeight:(this.style.height="auto",this.style.height="45px",this.style.height=this.scrollHeight+"px")}));const generateId=()=>{let e="";const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-";for(let n=0;n<10;n++)e+=t.charAt(Math.floor(63*Math.random()));return e},md=window.markdownit({highlight:function(e,t){let n=generateId();if(t&&window.hljs.getLanguage(t))try{return`<div class="codehead">\n\t<p>${t||"plaintext"}</p>\n\t<button onclick="copyCode('${n}')"><i class="fa-regular fa-copy"></i> salin</button>\n</div>\n<pre class="hljs">\n     <code id="${n}">${window.hljs.highlight(t,e,!0).value}</code>\n</pre>`}catch(e){}return`<div class="codehead">\n\t<p></p>\n\t<button onclick="copyCode()"><i class="fa-regular fa-copy"></i> salin</button>\n</div>\n<pre class="hljs">\n     <code id="code">${md.utils.escapeHtml(e)}</code>\n</pre>\n`}});function formatMessage(e){return md.render(e)}function getTime(){return(new Date).toLocaleTimeString("id-ID",{hour:"numeric",minute:"numeric",hour12:!0})}function errorMessage(e){const t=document.createElement("div");t.classList.add("chat-bubble"),t.classList.add("chat-receiver");const n=document.createElement("div");return n.classList.add("chat-content"),n.innerHTML=`<p class='err-msg'>${e}</p>`,t.appendChild(n),chatContainer.appendChild(t),t}function getLinkInfo(){document.querySelectorAll("a").forEach((function(e){(e.textContent.includes("[")&&e.textContent.includes("]")||e.textContent.includes("[[")&&e.textContent.includes("]]"))&&(e.style.color="#0484ff",e.textContent=e.textContent.replace("[","").replace("]",""),e.textContent=e.textContent.replace("[[","").replace("]]",""),e.style.textDecoration="none",e.style.backgroundColor="white",e.style.borderRadius="50px",e.style.paddingLeft="4.5px",e.style.paddingRight="4.5px",e.style.color="#0484ff",e.style.margin="0",e.style.verticalAlign="top",e.style.fontSize="11px",e.style.margin="3px",e.style.boxShadow="-3px -3px 7px #5e687960, 3px 3px 7px #5e687960")}))}async function processMessage(e){const t=document.createElement("div");t.classList.add("chat-bubble","chat-receiver");const n=document.createElement("div");n.classList.add("chat-content"),t.appendChild(n),chatContainer.appendChild(t);try{let a=await fetch("/check_prompt",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:e})});if(!a.ok)return n.innerHTML="",t;"imaging"===(await a.json()).cmd?n.innerHTML='\n                <div class="loading-img loading01">\n                    <span>I</span>\n                    <span>m</span>\n                    <span>a</span>\n                    <span>g</span>\n                    <span>i</span>\n                    <span>n</span>\n                    <span>i</span>\n                    <span>n</span>\n                    <span>g</span>\n                    <span>.</span>\n                    <span>.</span>\n                    <span>.</span>\n                </div>':n.innerHTML="<div class='loader'></div>"}catch(e){n.innerHTML=""}return t}function renderMessages(e){try{chatContainer.innerHTML="",e.forEach(((t,n)=>{const a=document.createElement("div");a.classList.add("chat-bubble"),"user"===t.role?a.classList.add("chat-sender"):a.classList.add("chat-receiver");const s=document.createElement("div");if(s.classList.add("chat-content"),"images"===t.role){const e=document.createElement("img");e.src=t.content,e.classList.add("chat-image"),s.appendChild(e),getLinkInfo()}else if("user"===t.role)if(console.log(t),t.content.image){console.log("message with image");const e=document.createElement("img");e.src=`data:image/png;base64,${t.content.image}`,s.appendChild(e),s.innerHTML+=t.content.text.replace(/\n/g,"<br>").replace(/\t/g,"&nbsp;&nbsp;&nbsp;nbsp;"),getLinkInfo()}else console.log("message without image"),s.innerHTML=t.content.replace(/\n/g,"<br>").replace(/\t/g,"&nbsp;&nbsp;&nbsp;nbsp;"),getLinkInfo();else if("user"!==t.role)if(getLinkInfo(),n===e.length-1){let e=0,n=formatMessage(t.content).split(" ");!function t(){var a=document.getElementById("btnSend");e<=n.length&&(s.innerHTML=n.slice(0,e).join(" "),e++,getLinkInfo(),window.scrollTo({top:chatContainer.scrollHeight,behavior:"smooth"}),e===n.length&&(a.innerHTML='<i class="fa-solid fa-arrow-up"></i>',a.disabled=!1),setTimeout(t,10))}()}else s.innerHTML=formatMessage(t.content),getLinkInfo();a.appendChild(s),chatContainer.appendChild(a)}))}catch(e){console.log(e)}}async function callback(e,t={}){try{let n=await fetch("/callback",{method:"POST",headers:{"Content-Type":"application/json","X-Action":"Kh816hhfaDshbJDwJKoFsWhHBXVNanajNvyio=="===atob(e.msg)?"revalidate":"message",...t},body:JSON.stringify({msg:e,chat_id:chatId})});return n.ok?await n.json():null}catch(e){return console.warn(e),null}}function generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))}async function sendMessage(e,t){try{await processMessage(e)||errorMessage("Failed to processing message");let n=messages.filter((e=>"images"!==e.role));window.location.href="#chat";const a=generateId(),s=await callback({msg:btoa(generateUUID().replace(/-/gi,a))},{"X-Id":a});if(s){if(t.content.image){t={role:"user",content:{image:pako.deflate(t.content.image,{to:"string"}),text:t.content.text}},console.log("Compresed data: ",t)}const e={coming:t,last:n,sessionHash:btoa(s.snd)};await socket.emit(`chat ${s.snd}`,e)}else console.log("Callback data is null, cannot send message")}catch(e){errorMessage(e.message||e)}}window.hljs.highlightAll(),socket.on("connect",(async function(){const e=await callback({msg:btoa("Kh816hhfaDshbJDwJKoFsWhHBXVNanajNvyio==")});e?socket.on(`chat ${e.rec}`,(async function(t){try{if(e.error)return window.alert("Error Occured");await addHistoryMsg(t),await renderMessages(messages),window.location.href="#chat"}catch(e){errorMessage(e)}})):console.log("Callback data is null, cannot listen for messages")}));